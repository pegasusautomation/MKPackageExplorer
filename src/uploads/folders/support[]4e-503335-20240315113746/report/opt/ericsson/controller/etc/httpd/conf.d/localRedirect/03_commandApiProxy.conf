# Command service

# ** Set the LOCAL_SERVER_ID Apache environment variable
# -- This is a workaround for SetEnv setting variables too late
# -- ^ resolves to true if any request uri is present (i.e. always)
SetEnvIf %{QUERY_STRING} ^ LOCAL_SERVER_ID=standalone

# ** Local server request case
# -- Check if the URI is correctly formatted and match the serverId value into a group
RewriteCond %{REQUEST_URI} ^/api/services/.*?/servers/(.*?)/command$
# -- Using the first group match from previous regex
# -- Compare <param>::<local_server_id> and <param>::<param>
# -- This checks if the serverId IS the local serverId
RewriteCond %1::%{ENV:LOCAL_SERVER_ID} ^(.*?)::\1$
# -- Use localhost and append querystring to url
RewriteRule "^/api/services/(.*)/servers/(.*)/command$" "http://127.0.0.1:8003/api/services/$1/servers/$2/command" [L,P]

# ** Remote server request case
# -- Declare rewrite map location
RewriteMap servermap txt:/opt/ericsson/controller/etc/serverid_mapping.cfg
# -- Check if the URI is correctly formatted and match the serverId value into a group
RewriteCond %{REQUEST_URI} ^/api/services/.*?/servers/(.*?)/command$
# -- Using the first group match from previous regex
# -- Compare <param>::<local_server_id> and <param>::<param>
# -- This checks if the serverId IS NOT the local serverId
RewriteCond %1::%{ENV:LOCAL_SERVER_ID} !^(.*?)::\1$
# -- Check that the servermap has an entry for the given serverId
RewriteCond ${servermap:%1} !^$
# -- Use the ip of the server in the servermap and append the querystring
RewriteRule "^/api/services/(.*)/servers/(.*)/command$" "http://${servermap:%1}/api/services/$1/servers/$2/command" [L,P]
