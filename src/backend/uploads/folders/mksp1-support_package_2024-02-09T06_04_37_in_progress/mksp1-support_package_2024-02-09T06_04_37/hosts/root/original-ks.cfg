text

%packages
@Core
%end

keyboard --xlayouts='us'
lang en_US.UTF-8

network --hostname=localhost.localdomain

harddrive --partition=/dev/disk/by-label/ALMALINUX8 --dir=/

%include /tmp/ks_partitions.txt

timezone Etc/UTC --isUtc

rootpw --iscrypted $6$obfnyx92Ox/LjPkr$ICUrmGomfVRTeba3FGGrob1ENhnOCq2uwN2M22SSgO2vGXRDOW57G98.Mhp5hdkJQrdV3503BdEUVpLGbCR9s/

logging --level=info

reboot

firewall --enabled --ssh --service=http,ssh

selinux --enforcing

skipx

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end

%pre 
sh  /run/install/repo/MediaKind/log_version.sh
%end

%post --nochroot
echo "Loading custom installation media"
cp -r /run/install/repo/MediaKind /mnt/sysroot/root
%end

%post 
echo "Installing extra tools"
rpm   -i /root/MediaKind/RPM/*.rpm

echo "Creating /var/log/journal to enable persistent logs"
mkdir -p /var/log/journal
chown root:systemd-journal /var/log/journal

echo "Cleaning third-party yum repositories"
yum clean all
echo "Disabling third-party yum repositories"
sed -i 's/enabled=./enabled=0/' /etc/yum.repos.d/*
echo "Enabling all network interfaces on boot"
sed -i 's/ONBOOT=no/ONBOOT=yes/' /etc/sysconfig/network-scripts/ifcfg-*

ln -s /var/log/anaconda/program.log /root/install.log
%end

%post --nochroot --erroronfail
export MEDIA_DEST=`cat /tmp/media_dest.txt`

cd /mnt/sysroot/root
mkdir -p ./bin ./.MediaKind/platform
cp /tmp/media_dest.txt ./.MediaKind/platform
cp ./MediaKind/system_backup.sh ../usr/local/sbin/system.backup
cp ./MediaKind/network_config.sh ./bin/network.config
cp ./MediaKind/machine_id.sh     ./bin/machine.id

BACKUP_SIZE=`cat /tmp/backup_size.txt`
if [ $BACKUP_SIZE -eq 0 ]
then
    echo "No backup service enabled - zero backup partition size selected"
    bash ./MediaKind/backup_partition.sh $BACKUP_SIZE
else
    echo "Configuring backup service - see 'system.backup --help'"
    bash ./MediaKind/backup_boot.sh
    bash ./MediaKind/backup_partition.sh $BACKUP_SIZE
fi
%end


%pre
sh   /run/install/repo/MediaKind/create_partition.sh --uefi --auto
echo -e "\n\r"
echo -e "\nPartitions selected for UEFI boot:\r"
echo -e "\n\r"
cat  /tmp/ks_partitions.txt
%end
